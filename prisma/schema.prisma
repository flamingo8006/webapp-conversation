// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 챗봇 앱 테이블
model ChatbotApp {
  id              String   @id @default(cuid())
  name            String                            // 레거시 호환용 (기본값)
  description     String?

  // 다국어 필드 (Phase 8a-2)
  nameKo          String?  @map("name_ko")
  nameEn          String?  @map("name_en")
  descriptionKo   String?  @map("description_ko")
  descriptionEn   String?  @map("description_en")

  difyAppId       String   @map("dify_app_id")
  apiKeyEncrypted String   @map("api_key_encrypted")  // 암호화된 API Key
  apiUrl          String   @default("https://api.dify.ai/v1") @map("api_url")
  iconUrl         String?  @map("icon_url")
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")

  // 공개 챗봇 설정 (Phase 7)
  isPublic          Boolean  @default(false) @map("is_public")           // 공개 챗봇 여부
  requireAuth       Boolean  @default(true) @map("require_auth")         // 인증 필수 여부
  allowAnonymous    Boolean  @default(false) @map("allow_anonymous")     // 익명 사용자 허용
  maxAnonymousMsgs  Int?     @map("max_anonymous_msgs")                  // 익명 사용자 최대 메시지 수 (null=무제한)

  // 감사 필드
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String?  @map("created_by")
  updatedAt       DateTime @updatedAt @map("updated_at")
  updatedBy       String?  @map("updated_by")
  deletedAt       DateTime? @map("deleted_at")
  deletedBy       String?  @map("deleted_by")

  // 관계
  sessions        ChatSession[]
  dailyStats      DailyUsageStats[]

  @@map("chatbot_apps")
}

// 채팅 세션 테이블
model ChatSession {
  id                 String   @id @default(cuid())

  // 익명/인증 사용자 구분 (Phase 7)
  isAnonymous        Boolean  @default(false) @map("is_anonymous")       // 익명 세션 여부
  sessionId          String?  @map("session_id")                         // 익명 사용자 브라우저 sessionId (UUID)

  // 레거시 인증 사용자 정보 (익명일 경우 null)
  userId             String?  @map("user_id")      // JWT의 empNo
  userLoginId        String?  @map("user_login_id") // JWT의 sub (loginId)
  userName           String?  @map("user_name")
  appId              String   @map("app_id")
  difyConversationId String?  @map("dify_conversation_id")
  title              String?

  // Phase 8c: 대화 목록 기능
  customTitle        String?  @map("custom_title")   // 사용자 지정 제목
  isPinned           Boolean  @default(false) @map("is_pinned")
  pinnedAt           DateTime? @map("pinned_at")

  isActive           Boolean  @default(true) @map("is_active")
  lastMessageAt      DateTime? @map("last_message_at")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // 관계
  app                ChatbotApp    @relation(fields: [appId], references: [id])
  messages           ChatMessage[]

  @@index([userId, appId])
  @@index([sessionId, appId])  // Phase 7: 익명 사용자 조회용
  @@index([difyConversationId])
  @@index([isPinned, lastMessageAt])  // Phase 8c: 고정+정렬용
  @@map("chat_sessions")
}

// 채팅 메시지 테이블
model ChatMessage {
  id              String   @id @default(cuid())
  sessionId       String   @map("session_id")
  difyMessageId   String?  @map("dify_message_id")
  parentMessageId String?  @map("parent_message_id")  // user 메시지 ID 참조 (assistant가 어떤 질문에 대한 답변인지)
  role            String   // 'user' | 'assistant'
  content         String   @db.Text
  files           Json?    // 첨부 파일 정보
  feedback        String?  // 'like' | 'dislike' | null
  tokenCount      Int?     @map("token_count")

  createdAt       DateTime @default(now()) @map("created_at")

  // 관계
  session         ChatSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@index([difyMessageId])
  @@index([parentMessageId])
  @@map("chat_messages")
}

// 관리자 테이블 (Phase 8b)
model Admin {
  id            String   @id @default(cuid())

  loginId       String   @unique @map("login_id")
  passwordHash  String   @map("password_hash")  // bcrypt
  name          String
  email         String?  @unique
  department    String?

  role          String   @default("admin")  // 'super_admin' | 'admin'
  isActive      Boolean  @default(true) @map("is_active")

  // Phase 9b: 로그인 시도 제한
  loginAttempts Int      @default(0) @map("login_attempts")  // 연속 실패 횟수
  lockedUntil   DateTime? @map("locked_until")               // 잠금 해제 시간 (null=잠금 안됨)

  // Phase 9b: 비밀번호 재사용 방지
  previousPasswordHash String? @map("previous_password_hash")  // 직전 비밀번호 해시

  lastLoginAt   DateTime? @map("last_login_at")
  lastLoginIp   String?   @map("last_login_ip")

  createdAt     DateTime @default(now()) @map("created_at")
  createdBy     String?  @map("created_by")  // 생성한 슈퍼관리자 ID
  updatedAt     DateTime @updatedAt @map("updated_at")
  updatedBy     String?  @map("updated_by")

  @@index([loginId])
  @@index([role])
  @@map("admins")
}

// 감사 로그 테이블 (Phase 8b)
model AuditLog {
  id            String   @id @default(cuid())

  // 행위자 정보 (스냅샷)
  actorType     String   @map("actor_type")  // 'admin' | 'user'
  actorId       String?  @map("actor_id")    // Admin.id 또는 empNo
  actorLoginId  String   @map("actor_login_id")
  actorName     String   @map("actor_name")
  actorRole     String?  @map("actor_role")

  // 이벤트 정보
  action        String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entityType    String   @map("entity_type")
  entityId      String?  @map("entity_id")

  // 변경 내용
  changes       Json?
  metadata      Json?

  // 요청 정보
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  requestPath   String?  @map("request_path")

  success       Boolean  @default(true)
  errorMessage  String?  @map("error_message")

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// 에러 로그 테이블 (Phase 8b)
model ErrorLog {
  id            String   @id @default(cuid())

  errorType     String   @map("error_type")
  errorCode     String?  @map("error_code")
  message       String
  stackTrace    String?  @map("stack_trace") @db.Text

  source        String   // API_ROUTE, MIDDLEWARE, CLIENT
  requestPath   String?  @map("request_path")
  requestMethod String?  @map("request_method")

  userEmpNo     String?  @map("user_emp_no")
  adminId       String?  @map("admin_id")
  sessionId     String?  @map("session_id")
  appId         String?  @map("app_id")

  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")

  status        String   @default("new")  // 'new' | 'investigating' | 'resolved' | 'ignored'
  resolvedAt    DateTime? @map("resolved_at")
  resolvedBy    String?  @map("resolved_by")
  resolution    String?

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([errorType])
  @@index([status])
  @@index([appId])
  @@index([createdAt])
  @@map("error_logs")
}

// 일별 사용 통계 테이블 (Phase 8b)
model DailyUsageStats {
  id            String   @id @default(cuid())

  date          DateTime @db.Date
  appId         String?  @map("app_id")

  totalSessions       Int @default(0) @map("total_sessions")
  newSessions         Int @default(0) @map("new_sessions")
  authSessions        Int @default(0) @map("auth_sessions")
  anonymousSessions   Int @default(0) @map("anonymous_sessions")

  totalMessages       Int @default(0) @map("total_messages")
  userMessages        Int @default(0) @map("user_messages")
  assistantMessages   Int @default(0) @map("assistant_messages")

  uniqueUsers         Int @default(0) @map("unique_users")
  totalTokens         Int @default(0) @map("total_tokens")

  likeFeedbacks       Int @default(0) @map("like_feedbacks")
  dislikeFeedbacks    Int @default(0) @map("dislike_feedbacks")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  app           ChatbotApp? @relation(fields: [appId], references: [id])

  @@unique([date, appId])
  @@index([date])
  @@index([appId])
  @@map("daily_usage_stats")
}
