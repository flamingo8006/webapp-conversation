<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DGIST AI ì±—ë´‡ - Embed ìƒ˜í”Œ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    p {
      font-size: 1.2rem;
      line-height: 1.6;
      margin-bottom: 2rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    button {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 1rem;
      margin-bottom: 1rem;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
    #status {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– DGIST AI ì±—ë´‡ Embed ìƒ˜í”Œ</h1>
    <p>ì´ í˜ì´ì§€ëŠ” iframeìœ¼ë¡œ ì±—ë´‡ì„ ì‚½ì…í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤. ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— í”Œë¡œíŒ… ë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>

    <div class="card">
      <h2 style="margin-top: 0;">ğŸ“‹ ì„¤ì •</h2>
      <p style="font-size: 1rem; margin-bottom: 1rem;">
        <strong>App ID:</strong> <code id="appIdDisplay">ë¡œë”© ì¤‘...</code>
      </p>
      <p style="font-size: 0.9rem; margin-bottom: 0;">
        iframeì´ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ í•˜ë‹¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
      </p>
    </div>

    <div class="card">
      <h2 style="margin-top: 0;">ğŸ® ì»¨íŠ¸ë¡¤</h2>
      <button onclick="openChat()">ì±„íŒ… ì—´ê¸°</button>
      <button onclick="closeChat()">ì±„íŒ… ë‹«ê¸°</button>
      <button onclick="toggleChat()">ì±„íŒ… í† ê¸€</button>
      <div id="status"></div>
    </div>

    <div class="card">
      <h2 style="margin-top: 0;">ğŸ“– ì‚¬ìš© ë°©ë²•</h2>
      <ol style="font-size: 0.95rem; line-height: 1.8;">
        <li>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ì±—ë´‡ì„ ìƒì„±í•©ë‹ˆë‹¤.</li>
        <li>ì±—ë´‡ IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li>
        <li>ì•„ë˜ ì½”ë“œë¥¼ ì™¸ë¶€ ì›¹ì‚¬ì´íŠ¸ì— ì‚½ì…í•©ë‹ˆë‹¤.</li>
      </ol>
      <pre style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.85rem;"><code>&lt;!-- ì±—ë´‡ Embed ì½”ë“œ --&gt;
&lt;iframe
  id="dgist-chatbot"
  src="http://localhost:3000/embed/YOUR_APP_ID?token=YOUR_JWT_TOKEN"
  style="position: fixed; bottom: 0; right: 0; width: 100%; height: 100%; border: none; pointer-events: none; z-index: 9999;"
  allow="clipboard-write"
&gt;&lt;/iframe&gt;

&lt;script&gt;
  // ì±„íŒ… ì œì–´
  const chatFrame = document.getElementById('dgist-chatbot');

  function openChat() {
    chatFrame.contentWindow.postMessage({ type: 'OPEN_CHAT' }, '*');
  }

  function closeChat() {
    chatFrame.contentWindow.postMessage({ type: 'CLOSE_CHAT' }, '*');
  }
&lt;/script&gt;</code></pre>
    </div>
  </div>

  <!-- ì±—ë´‡ iframe -->
  <iframe
    id="dgist-chatbot"
    src=""
    style="position: fixed; bottom: 0; right: 0; width: 100%; height: 100%; border: none; pointer-events: none; z-index: 9999;"
    allow="clipboard-write"
  ></iframe>

  <script>
    // 1. JWT í† í° ë°œê¸‰
    async function getToken() {
      try {
        const response = await fetch('http://localhost:3000/api/auth/embed-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            loginId: 'embed_user',
            empNo: '99999',
            name: 'Embed í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
            role: 'user'
          })
        });

        if (!response.ok) {
          throw new Error('Failed to get token');
        }

        const data = await response.json();
        return data.token;
      } catch (error) {
        console.error('Token error:', error);
        updateStatus('í† í° ë°œê¸‰ ì‹¤íŒ¨: ' + error.message);
        return null;
      }
    }

    // 2. ì±—ë´‡ ëª©ë¡ì—ì„œ ì²« ë²ˆì§¸ ì•± ê°€ì ¸ì˜¤ê¸°
    async function getFirstApp() {
      try {
        // ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í° íšë“
        const loginResponse = await fetch('http://localhost:3000/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            loginId: 'admin',
            password: 'admin123'
          })
        });

        if (!loginResponse.ok) {
          throw new Error('Login failed');
        }

        // ì±—ë´‡ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const appsResponse = await fetch('http://localhost:3000/api/admin/apps', {
          credentials: 'include'
        });

        if (!appsResponse.ok) {
          throw new Error('Failed to fetch apps');
        }

        const apps = await appsResponse.json();

        if (apps.length === 0) {
          throw new Error('No apps found. Please create a chatbot first.');
        }

        return apps[0];
      } catch (error) {
        console.error('Get app error:', error);
        updateStatus('ì±—ë´‡ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        return null;
      }
    }

    // 3. iframe ì´ˆê¸°í™”
    async function initEmbed() {
      updateStatus('ì´ˆê¸°í™” ì¤‘...');

      const app = await getFirstApp();
      if (!app) {
        updateStatus('âŒ ì±—ë´‡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì±—ë´‡ì„ ìƒì„±í•˜ì„¸ìš”.');
        return;
      }

      document.getElementById('appIdDisplay').textContent = app.id;
      updateStatus('ì•± ë¡œë“œ ì™„ë£Œ: ' + app.name);

      const token = await getToken();
      if (!token) {
        return;
      }

      updateStatus('í† í° ë°œê¸‰ ì™„ë£Œ');

      // iframe src ì„¤ì •
      const iframe = document.getElementById('dgist-chatbot');
      iframe.src = `http://localhost:3000/embed/${app.id}?token=${token}`;

      // iframe ë¡œë“œ ì™„ë£Œ í›„
      iframe.onload = () => {
        updateStatus('âœ… ì±—ë´‡ ë¡œë“œ ì™„ë£Œ! ì˜¤ë¥¸ìª½ í•˜ë‹¨ ë²„íŠ¼ì„ í™•ì¸í•˜ì„¸ìš”.');
      };
    }

    // ì±„íŒ… ì œì–´ í•¨ìˆ˜
    function openChat() {
      const iframe = document.getElementById('dgist-chatbot');
      iframe.contentWindow.postMessage({ type: 'OPEN_CHAT' }, '*');
      updateStatus('ì±„íŒ… ì—´ê¸° ëª…ë ¹ ì „ì†¡');
    }

    function closeChat() {
      const iframe = document.getElementById('dgist-chatbot');
      iframe.contentWindow.postMessage({ type: 'CLOSE_CHAT' }, '*');
      updateStatus('ì±„íŒ… ë‹«ê¸° ëª…ë ¹ ì „ì†¡');
    }

    function toggleChat() {
      const iframe = document.getElementById('dgist-chatbot');
      iframe.contentWindow.postMessage({ type: 'TOGGLE_CHAT' }, '*');
      updateStatus('ì±„íŒ… í† ê¸€ ëª…ë ¹ ì „ì†¡');
    }

    function updateStatus(message) {
      const status = document.getElementById('status');
      const timestamp = new Date().toLocaleTimeString();
      status.innerHTML = `[${timestamp}] ${message}`;
    }

    // ì±—ë´‡ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', (event) => {
      if (event.data.type === 'CHAT_STATUS') {
        const { isOpen, unreadCount } = event.data.data;
        updateStatus(`ì±„íŒ… ìƒíƒœ: ${isOpen ? 'ì—´ë¦¼' : 'ë‹«í˜'}, ì½ì§€ ì•Šì€ ë©”ì‹œì§€: ${unreadCount}`);
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    initEmbed();
  </script>
</body>
</html>
